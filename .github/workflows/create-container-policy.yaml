name: Create Vision One Container Security Policy

on:
  workflow_dispatch:
    inputs:
      ruleset_name:
        description: 'Ruleset Name'
        required: false
        default: 'DemoLogOnlyRuleset'
      policy_name:
        description: 'Policy Name'
        required: false
        default: 'DemoLogOnlyPolicy'

env:
  API_URL: https://api.xdr.trendmicro.com/beta/containerSecurity
  API_KEY: ${{ secrets.CONTAINER_SECURITY_API_KEY }}
  RULESET_NAME: ${{ github.event.inputs.ruleset_name }}
  POLICY_NAME: ${{ github.event.inputs.policy_name }}

jobs:
  check-policy:
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Check if Policy Exists
        id: check
        run: |
          set +e
          python trendmicro/scripts/check_policy.py
          status=$?
          echo "Script exited with code $status"
          if [ "$status" -eq 1 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            exit 1
          elif [ "$status" -eq 2 ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ðŸ”¥ Unknown error."
            exit $status
          fi

      - name: Summary - Check Policy
        run: |
          echo "## Check Policy Job" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Name: ${{ env.POLICY_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exists: ${{ steps.check.outputs.exists }}" >> $GITHUB_STEP_SUMMARY

  check-ruleset:
    runs-on: ubuntu-latest
    needs: check-policy
    outputs:
      exists: ${{ steps.check.outputs.exists }}
      ruleset_id: ${{ steps.check.outputs.ruleset_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Check Ruleset
        id: check
        run: |
          set +e
          output=$(python trendmicro/scripts/check_ruleset.py)
          status=$?
          echo "$output"
          if [ "$status" -eq 0 ]; then
            id=$(echo "$output" | awk -F'id=' '{print $2}')
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ruleset_id=$id" >> $GITHUB_OUTPUT
          elif [ "$status" -eq 2 ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            exit $status
          fi

      - name: Summary - Check Ruleset
        run: |
          echo "## Check Ruleset Job" >> $GITHUB_STEP_SUMMARY
          echo "- Ruleset Name: ${{ env.RULESET_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exists: ${{ steps.check.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ruleset ID: ${{ steps.check.outputs.ruleset_id }}" >> $GITHUB_STEP_SUMMARY

  create-policy:
    runs-on: ubuntu-latest
    needs: check-ruleset
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Create Policy
        id: policy
        run: |
          set +e
          output=$(python trendmicro/scripts/create_policy.py 2>&1)
          status=$?
          echo "$output"
          if [ "$status" -eq 0 ]; then
            policy_id=$(echo "$output" | grep 'policy_id=' | awk -F'=' '{print $2}')
            echo "policy_id=$policy_id" >> $GITHUB_OUTPUT
          fi
          exit $status

      - name: Summary - Create Policy
        run: |
          echo "## Create Policy Job" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Name: ${{ env.POLICY_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Policy ID: ${{ steps.policy.outputs.policy_id }}" >> $GITHUB_STEP_SUMMARY
